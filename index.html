<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Switch</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#4F4FC5',
                        dark: '#181818',
                        light: '#FFFFFF',
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <!-- MQTT Client -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="transition-colors duration-300 bg-light dark:bg-dark min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-md">
        <!-- Authentication Section -->
        <div id="auth-section" class="text-center">
            <h1 class="text-3xl font-bold mb-8 text-gray-800 dark:text-white">
                <i class="fas fa-bolt text-primary"></i> Smart Switch
            </h1>
            
            <div id="auth-tabs" class="mb-6 flex rounded-lg overflow-hidden border border-gray-200 dark:border-gray-700">
                <button id="login-tab" class="flex-1 py-3 font-medium bg-primary text-white">تسجيل الدخول</button>
                <button id="register-tab" class="flex-1 py-3 font-medium bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300">إنشاء حساب</button>
            </div>
            
            <!-- Login Form -->
            <div id="login-form" class="text-left">
                <div class="mb-4">
                    <label for="login-email" class="block mb-2 text-right text-sm font-medium text-gray-700 dark:text-gray-300">البريد الإلكتروني</label>
                    <input type="email" id="login-email" dir="rtl" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800 dark:text-white" placeholder="أدخل البريد الإلكتروني">
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block mb-2 text-right text-sm font-medium text-gray-700 dark:text-gray-300">كلمة المرور (4 أرقام)</label>
                    <input type="password" id="login-password" dir="rtl" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800 dark:text-white" placeholder="أدخل كلمة المرور" maxlength="4" pattern="[0-9]*" inputmode="numeric">
                </div>
                <button id="login-button" class="w-full py-3 text-white font-medium rounded-lg bg-primary hover:bg-secondary transition-colors">تسجيل الدخول</button>
                <div id="login-error" class="mt-3 text-red-500 text-center hidden"></div>
            </div>
            
            <!-- Register Form -->
            <div id="register-form" class="text-left hidden">
                <div class="mb-4">
                    <label for="register-email" class="block mb-2 text-right text-sm font-medium text-gray-700 dark:text-gray-300">البريد الإلكتروني</label>
                    <input type="email" id="register-email" dir="rtl" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800 dark:text-white" placeholder="أدخل البريد الإلكتروني">
                </div>
                <div class="mb-4">
                    <label for="register-username" class="block mb-2 text-right text-sm font-medium text-gray-700 dark:text-gray-300">اسم المستخدم</label>
                    <input type="text" id="register-username" dir="rtl" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800 dark:text-white" placeholder="أدخل اسم المستخدم">
                </div>
                <div class="mb-4">
                    <label for="register-password" class="block mb-2 text-right text-sm font-medium text-gray-700 dark:text-gray-300">كلمة المرور (4 أرقام)</label>
                    <input type="password" id="register-password" dir="rtl" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800 dark:text-white" placeholder="أدخل 4 أرقام" maxlength="4" pattern="[0-9]*" inputmode="numeric">
                </div>
                <div class="mb-4">
                    <label for="device-id" class="block mb-2 text-right text-sm font-medium text-gray-700 dark:text-gray-300">رمز الجهاز</label>
                    <input type="text" id="device-id" dir="rtl" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800 dark:text-white" placeholder="أدخل رمز الجهاز">
                </div>
                <button id="register-button" class="w-full py-3 text-white font-medium rounded-lg bg-primary hover:bg-secondary transition-colors">إنشاء حساب</button>
                <div id="register-error" class="mt-3 text-red-500 text-center hidden"></div>
            </div>
        </div>
        
        <!-- Device Setup Section (Initially Hidden) -->
        <div id="device-setup-section" class="hidden">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">إعداد الجهاز</h2>
                <button id="logout-button" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white">
                    <i class="fas fa-sign-out-alt"></i> خروج
                </button>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-medium mb-4 text-gray-800 dark:text-white text-right">إعداد WiFi</h3>
                <div class="mb-4">
                    <label for="wifi-ssid" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300 text-right">اسم الشبكة (SSID)</label>
                    <input type="text" id="wifi-ssid" dir="rtl" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800 dark:text-white" placeholder="أدخل اسم الشبكة">
                </div>
                <div class="mb-4">
                    <label for="wifi-password" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300 text-right">كلمة مرور WiFi</label>
                    <input type="password" id="wifi-password" dir="rtl" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800 dark:text-white" placeholder="أدخل كلمة المرور">
                </div>
                <button id="wifi-setup-button" class="w-full py-3 text-white font-medium rounded-lg bg-primary hover:bg-secondary transition-colors">حفظ إعدادات WiFi</button>
                
                <div class="mt-5 p-4 bg-blue-50 dark:bg-blue-900 rounded-lg">
                    <h4 class="font-medium text-blue-800 dark:text-blue-200 mb-2 text-right">كيفية الإعداد:</h4>
                    <ol class="list-decimal list-inside text-blue-700 dark:text-blue-300 text-right space-y-1">
                        <li>قم بتوصيل الجهاز بالكهرباء</li>
                        <li>انتظر حتى يومض المؤشر</li>
                        <li>اتصل بشبكة WiFi الخاصة بالجهاز (تبدأ بـ SmartSwitch-)</li>
                        <li>أدخل بيانات WiFi الخاصة بك هنا</li>
                        <li>انقر على حفظ</li>
                    </ol>
                </div>
            </div>
            
            <button id="continue-to-dashboard" class="w-full py-3 text-white font-medium rounded-lg bg-green-600 hover:bg-green-700 transition-colors">متابعة إلى لوحة التحكم</button>
        </div>
        
        <!-- Dashboard Section (Initially Hidden) -->
        <div id="dashboard-section" class="hidden">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">لوحة التحكم</h2>
                <div>
                    <button id="settings-button" class="mr-3 text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button id="dashboard-logout-button" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <button id="add-switch-button" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors">
                        <i class="fas fa-plus"></i> إضافة مفتاح
                    </button>
                    <h3 class="text-lg font-medium text-gray-800 dark:text-white">المفاتيح الذكية</h3>
                </div>
                
                <div id="switches-container" class="space-y-4">
                    <!-- Switches will be added here dynamically -->
                </div>
            </div>
            
            <div id="connection-status" class="text-center text-sm text-gray-600 dark:text-gray-400">
                <span id="status-indicator" class="inline-block w-2 h-2 rounded-full bg-red-500 mr-1"></span>
                <span id="status-text">غير متصل</span>
            </div>
        </div>
        
        <!-- Add Switch Modal -->
        <div id="add-switch-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4">
                <h3 class="text-xl font-medium mb-4 text-gray-800 dark:text-white text-right">إضافة مفتاح جديد</h3>
                <div class="mb-4">
                    <label for="switch-name" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300 text-right">اسم المفتاح</label>
                    <input type="text" id="switch-name" dir="rtl" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800 dark:text-white" placeholder="مثال: التلفاز، المروحة، إلخ">
                </div>
                <div class="mb-4">
                    <label for="switch-port" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300 text-right">رقم المنفذ</label>
                    <select id="switch-port" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800 dark:text-white text-right">
                        <option value="1">منفذ 1</option>
                        <option value="2">منفذ 2</option>
                        <option value="3">منفذ 3</option>
                        <option value="4">منفذ 4</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="add-switch-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600 ml-3">إلغاء</button>
                    <button id="add-switch-save" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors">حفظ</button>
                </div>
            </div>
        </div>
        
        <!-- Settings Modal -->
        <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4">
                <h3 class="text-xl font-medium mb-4 text-gray-800 dark:text-white text-right">الإعدادات</h3>
                
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-3 text-gray-700 dark:text-gray-300 text-right">تغيير كلمة المرور</h4>
                    <div class="mb-4">
                        <label for="current-password" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300 text-right">كلمة المرور الحالية</label>
                        <input type="password" id="current-password" dir="rtl" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800 dark:text-white" maxlength="4" pattern="[0-9]*" inputmode="numeric">
                    </div>
                    <div class="mb-4">
                        <label for="new-password" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300 text-right">كلمة المرور الجديدة</label>
                        <input type="password" id="new-password" dir="rtl" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800 dark:text-white" maxlength="4" pattern="[0-9]*" inputmode="numeric">
                    </div>
                    <button id="change-password-button" class="w-full py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors">تغيير كلمة المرور</button>
                </div>
                
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-3 text-gray-700 dark:text-gray-300 text-right">إعدادات WiFi</h4>
                    <div class="mb-4">
                        <label for="settings-wifi-ssid" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300 text-right">اسم الشبكة (SSID)</label>
                        <input type="text" id="settings-wifi-ssid" dir="rtl" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800 dark:text-white">
                    </div>
                    <div class="mb-4">
                        <label for="settings-wifi-password" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300 text-right">كلمة مرور WiFi</label>
                        <input type="password" id="settings-wifi-password" dir="rtl" class="w-full px-4 py-3 text-base rounded-lg border border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-800 dark:text-white">
                    </div>
                    <button id="update-wifi-button" class="w-full py-2 bg-primary text-white rounded-lg hover:bg-secondary transition-colors">تحديث إعدادات WiFi</button>
                </div>
                
                <button id="settings-close" class="w-full py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600">إغلاق</button>
            </div>
        </div>
        
        <!-- Loading Spinner -->
        <div id="loading-spinner" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 flex flex-col items-center">
                <div class="spinner w-12 h-12 border-4 border-t-primary border-r-transparent border-b-transparent border-l-transparent rounded-full animate-spin mb-4"></div>
                <p id="loading-text" class="text-gray-700 dark:text-gray-300">جاري التحميل...</p>
            </div>
        </div>
    </div>

    <script>
        // Check for dark mode preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // DOM Elements
        const authSection = document.getElementById('auth-section');
        const deviceSetupSection = document.getElementById('device-setup-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const loginTab = document.getElementById('login-tab');
        const registerTab = document.getElementById('register-tab');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginButton = document.getElementById('login-button');
        const registerButton = document.getElementById('register-button');
        const loginError = document.getElementById('login-error');
        const registerError = document.getElementById('register-error');
        const logoutButton = document.getElementById('logout-button');
        const dashboardLogoutButton = document.getElementById('dashboard-logout-button');
        const wifiSetupButton = document.getElementById('wifi-setup-button');
        const continueButton = document.getElementById('continue-to-dashboard');
        const addSwitchButton = document.getElementById('add-switch-button');
        const addSwitchModal = document.getElementById('add-switch-modal');
        const addSwitchSave = document.getElementById('add-switch-save');
        const addSwitchCancel = document.getElementById('add-switch-cancel');
        const settingsButton = document.getElementById('settings-button');
        const settingsModal = document.getElementById('settings-modal');
        const settingsClose = document.getElementById('settings-close');
        const switchesContainer = document.getElementById('switches-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const loadingText = document.getElementById('loading-text');
        const connectionStatus = document.getElementById('connection-status');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        
        // MQTT Client
        let mqttClient = null;
        const MQTT_BROKER_URL = 'wss://broker.hivemq.com:8884/mqtt';
        let deviceTopic = ''; // Will be set upon login
        
        // User and device state
        let currentUser = null;
        let userSwitches = [];
        
        // Initialize from localStorage if available (mock storage)
        let userStorage = {};
        let deviceStorage = {};
        
        // Helper function to show loading spinner
        function showLoading(message = 'جاري التحميل...') {
            loadingText.textContent = message;
            loadingSpinner.classList.remove('hidden');
        }
        
        function hideLoading() {
            loadingSpinner.classList.add('hidden');
        }
        
        // Tab switching
        loginTab.addEventListener('click', () => {
            loginTab.classList.add('bg-primary', 'text-white');
            loginTab.classList.remove('bg-gray-100', 'text-gray-700', 'dark:bg-gray-800', 'dark:text-gray-300');
            registerTab.classList.remove('bg-primary', 'text-white');
            registerTab.classList.add('bg-gray-100', 'text-gray-700', 'dark:bg-gray-800', 'dark:text-gray-300');
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            loginError.classList.add('hidden');
        });
        
        registerTab.addEventListener('click', () => {
            registerTab.classList.add('bg-primary', 'text-white');
            registerTab.classList.remove('bg-gray-100', 'text-gray-700', 'dark:bg-gray-800', 'dark:text-gray-300');
            loginTab.classList.remove('bg-primary', 'text-white');
            loginTab.classList.add('bg-gray-100', 'text-gray-700', 'dark:bg-gray-800', 'dark:text-gray-300');
            registerForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
            registerError.classList.add('hidden');
        });
        
        // Login form submission
        loginButton.addEventListener('click', () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                loginError.textContent = 'يرجى إدخال البريد الإلكتروني وكلمة المرور';
                loginError.classList.remove('hidden');
                return;
            }
            
            if (password.length !== 4 || !/^\d+$/.test(password)) {
                loginError.textContent = 'كلمة المرور يجب أن تتكون من 4 أرقام';
                loginError.classList.remove('hidden');
                return;
            }
            
            showLoading('جاري تسجيل الدخول...');
            
            // Simulate API call to login
            setTimeout(() => {
                if (userStorage[email] && userStorage[email].password === password) {
                    currentUser = {
                        email: email,
                        username: userStorage[email].username,
                        deviceId: userStorage[email].deviceId
                    };
                    
                    // Set device topic for MQTT
                    deviceTopic = `smartswitch/${currentUser.deviceId}`;
                    
                    // Load user switches if available
                    if (deviceStorage[currentUser.deviceId]) {
                        userSwitches = deviceStorage[currentUser.deviceId].switches || [];
                    } else {
                        userSwitches = [];
                    }
                    
                    hideLoading();
                    
                    // Check if WiFi was setup before
                    if (deviceStorage[currentUser.deviceId] && deviceStorage[currentUser.deviceId].wifiSetup) {
                        goToDashboard();
                    } else {
                        goToDeviceSetup();
                    }
                } else {
                    hideLoading();
                    loginError.textContent = 'البريد الإلكتروني أو كلمة المرور غير صحيحة';
                    loginError.classList.remove('hidden');
                }
            }, 1000);
        });
        
        // Register form submission
        registerButton.addEventListener('click', () => {
            const email = document.getElementById('register-email').value;
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const deviceId = document.getElementById('device-id').value;
            
            if (!email || !username || !password || !deviceId) {
                registerError.textContent = 'يرجى ملء جميع الحقول';
                registerError.classList.remove('hidden');
                return;
            }
            
            if (password.length !== 4 || !/^\d+$/.test(password)) {
                registerError.textContent = 'كلمة المرور يجب أن تتكون من 4 أرقام';
                registerError.classList.remove('hidden');
                return;
            }
            
            showLoading('جاري إنشاء الحساب...');
            
            // Simulate API call to register
            setTimeout(() => {
                if (userStorage[email]) {
                    hideLoading();
                    registerError.textContent = 'البريد الإلكتروني مستخدم بالفعل';
                    registerError.classList.remove('hidden');
                } else {
                    // Store user data
                    userStorage[email] = {
                        username: username,
                        password: password,
                        deviceId: deviceId
                    };
                    
                    // Initialize device storage
                    if (!deviceStorage[deviceId]) {
                        deviceStorage[deviceId] = {
                            wifiSetup: false,
                            switches: []
                        };
                    }
                    
                    currentUser = {
                        email: email,
                        username: username,
                        deviceId: deviceId
                    };
                    
                    // Set device topic for MQTT
                    deviceTopic = `smartswitch/${currentUser.deviceId}`;
                    
                    hideLoading();
                    goToDeviceSetup();
                }
            }, 1000);
        });
        
        // WiFi setup submission
        wifiSetupButton.addEventListener('click', () => {
            const ssid = document.getElementById('wifi-ssid').value;
            const password = document.getElementById('wifi-password').value;
            
            if (!ssid || !password) {
                alert('يرجى إدخال اسم الشبكة وكلمة المرور');
                return;
            }
            
            showLoading('جاري إعداد WiFi...');
            
            // Simulate sending WiFi credentials to device
            setTimeout(() => {
                // Store WiFi setup info
                if (deviceStorage[currentUser.deviceId]) {
                    deviceStorage[currentUser.deviceId].wifiSetup = true;
                    deviceStorage[currentUser.deviceId].wifi = {
                        ssid: ssid,
                        password: password
                    };
                }
                
                hideLoading();
                
                // Update settings page with the new WiFi info
                document.getElementById('settings-wifi-ssid').value = ssid;
                document.getElementById('settings-wifi-password').value = password;
                
                // Enable the continue button
                continueButton.disabled = false;
                continueButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }, 2000);
        });
        
        // Continue to dashboard button
        continueButton.addEventListener('click', () => {
            goToDashboard();
        });
        
        // Logout buttons
        logoutButton.addEventListener('click', logout);
        dashboardLogoutButton.addEventListener('click', logout);
        
        function logout() {
            // Disconnect MQTT client if connected
            if (mqttClient && mqttClient.connected) {
                mqttClient.end();
            }
            
            // Reset state
            currentUser = null;
            userSwitches = [];
            deviceTopic = '';
            
            // Reset forms
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('register-email').value = '';
            document.getElementById('register-username').value = '';
            document.getElementById('register-password').value = '';
            document.getElementById('device-id').value = '';
            
            // Show auth section
            authSection.classList.remove('hidden');
            deviceSetupSection.classList.add('hidden');
            dashboardSection.classList.add('hidden');
            
            // Reset to login tab
            loginTab.click();
        }
        
        // Settings button
        settingsButton.addEventListener('click', () => {
            // Populate WiFi settings if available
            if (deviceStorage[currentUser.deviceId] && deviceStorage[currentUser.deviceId].wifi) {
                document.getElementById('settings-wifi-ssid').value = deviceStorage[currentUser.deviceId].wifi.ssid;
                document.getElementById('settings-wifi-password').value = deviceStorage[currentUser.deviceId].wifi.password;
            }
            
            // Clear password fields
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            
            settingsModal.classList.remove('hidden');
        });
        
        settingsClose.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });
        
        // Change password
        document.getElementById('change-password-button').addEventListener('click', () => {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            
            if (!currentPassword || !newPassword) {
                alert('يرجى إدخال كلمة المرور الحالية والجديدة');
                return;
            }
            
            if (newPassword.length !== 4 || !/^\d+$/.test(newPassword)) {
                alert('كلمة المرور الجديدة يجب أن تتكون من 4 أرقام');
                return;
            }
            
            if (userStorage[currentUser.email].password !== currentPassword) {
                alert('كلمة المرور الحالية غير صحيحة');
                return;
            }
            
            showLoading('جاري تغيير كلمة المرور...');
            
            // Simulate API call to change password
            setTimeout(() => {
                userStorage[currentUser.email].password = newPassword;
                hideLoading();
                alert('تم تغيير كلمة المرور بنجاح');
                settingsModal.classList.add('hidden');
            }, 1000);
        });
        
        // Update WiFi settings
        document.getElementById('update-wifi-button').addEventListener('click', () => {
            const ssid = document.getElementById('settings-wifi-ssid').value;
            const password = document.getElementById('settings-wifi-password').value;
            
            if (!ssid || !password) {
                alert('يرجى إدخال اسم الشبكة وكلمة المرور');
                return;
            }
            
            showLoading('جاري تحديث إعدادات WiFi...');
            
            // Simulate sending WiFi update to device
            setTimeout(() => {
                // Store updated WiFi info
                if (deviceStorage[currentUser.deviceId]) {
                    deviceStorage[currentUser.deviceId].wifi = {
                        ssid: ssid,
                        password: password
                    };
                }
                
                // Send MQTT message to update WiFi on device
                if (mqttClient && mqttClient.connected) {
                    const message = JSON.stringify({
                        type: 'wifi_update',
                        ssid: ssid,
                        password: password
                    });
                    mqttClient.publish(`${deviceTopic}/config`, message);
                }
                
                hideLoading();
                alert('تم تحديث إعدادات WiFi بنجاح');
                settingsModal.classList.add('hidden');
            }, 2000);
        });
        
        // Add switch button
        addSwitchButton.addEventListener('click', () => {
            // Clear form
            document.getElementById('switch-name').value = '';
            document.getElementById('switch-port').value = '1';
            
            addSwitchModal.classList.remove('hidden');
        });
        
        addSwitchCancel.addEventListener('click', () => {
            addSwitchModal.classList.add('hidden');
        });
        
        addSwitchSave.addEventListener('click', () => {
            const name = document.getElementById('switch-name').value;
            const port = document.getElementById('switch-port').value;
            
            if (!name) {
                alert('يرجى إدخال اسم للمفتاح');
                return;
            }
            
            // Check if port is already used
            const existingSwitch = userSwitches.find(s => s.port === port);
            if (existingSwitch) {
                const confirmed = confirm(`المنفذ ${port} مستخدم بالفعل بواسطة "${existingSwitch.name}". هل تريد استبداله؟`);
                if (!confirmed) return;
                
                // Remove existing switch
                userSwitches = userSwitches.filter(s => s.port !== port);
            }
            
            // Add new switch
            const newSwitch = {
                id: Date.now().toString(),
                name: name,
                port: port,
                state: false // Initially off
            };
            
            userSwitches.push(newSwitch);
            
            // Update device storage
            if (deviceStorage[currentUser.deviceId]) {
                deviceStorage[currentUser.deviceId].switches = userSwitches;
            }
            
            renderSwitches();
            addSwitchModal.classList.add('hidden');
        });
        
        // Render switches in the dashboard
        function renderSwitches() {
            switchesContainer.innerHTML = '';
            
            if (userSwitches.length === 0) {
                switchesContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-600 dark:text-gray-400">
                        <i class="fas fa-lightbulb text-3xl mb-3 opacity-30"></i>
                        <p>لم تقم بإضافة أي مفاتيح بعد</p>
                    </div>
                `;
                return;
            }
            
            userSwitches.forEach(sw => {
                const switchEl = document.createElement('div');
                switchEl.className = 'bg-gray-100 dark:bg-gray-700 rounded-lg p-4 flex items-center justify-between';
                switchEl.innerHTML = `
                    <div>
                        <h4 class="font-medium text-gray-800 dark:text-white">${sw.name}</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400">منفذ ${sw.port}</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" class="switch-toggle sr-only" data-id="${sw.id}" data-port="${sw.port}" ${sw.state ? 'checked' : ''}>
                        <div class="w-14 h-7 bg-gray-300 dark:bg-gray-600 rounded-full peer-checked:after:translate-x-7 after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-primary"></div>
                    </label>
                `;
                switchesContainer.appendChild(switchEl);
                
                // Add toggle event listener
                const toggleInput = switchEl.querySelector('.switch-toggle');
                toggleInput.addEventListener('change', (e) => {
                    const switchId = e.target.dataset.id;
                    const port = e.target.dataset.port;
                    const isOn = e.target.checked;
                    
                    // Update switch state locally
                    const switchIndex = userSwitches.findIndex(s => s.id === switchId);
                    if (switchIndex !== -1) {
                        userSwitches[switchIndex].state = isOn;
                        
                        // Update device storage
                        if (deviceStorage[currentUser.deviceId]) {
                            deviceStorage[currentUser.deviceId].switches = userSwitches;
                        }
                        
                        // Send MQTT message to update device
                        if (mqttClient && mqttClient.connected) {
                            const message = JSON.stringify({
                                type: 'switch_update',
                                port: port,
                                state: isOn ? 'on' : 'off'
                            });
                            mqttClient.publish(`${deviceTopic}/control`, message);
                        }
                    }
                });
            });
        }
        
        // Navigation functions
        function goToDeviceSetup() {
            authSection.classList.add('hidden');
            deviceSetupSection.classList.remove('hidden');
            dashboardSection.classList.add('hidden');
            
            // If WiFi was already set up, enable continue button
            continueButton.disabled = !deviceStorage[currentUser.deviceId]?.wifiSetup;
            if (continueButton.disabled) {
                continueButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                continueButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            // Pre-fill WiFi settings if available
            if (deviceStorage[currentUser.deviceId]?.wifi) {
                document.getElementById('wifi-ssid').value = deviceStorage[currentUser.deviceId].wifi.ssid;
                document.getElementById('wifi-password').value = deviceStorage[currentUser.deviceId].wifi.password;
            }
        }
        
        function goToDashboard() {
            authSection.classList.add('hidden');
            deviceSetupSection.classList.add('hidden');
            dashboardSection.classList.remove('hidden');
            
            // Connect to MQTT broker
            connectMQTT();
            
            // Render user's switches
            renderSwitches();
        }
        
        // MQTT connection
        function connectMQTT() {
            showLoading('جاري الاتصال بالجهاز...');
            
            // Update status
            statusIndicator.classList.remove('bg-green-500');
            statusIndicator.classList.add('bg-yellow-500');
            statusText.textContent = 'جاري الاتصال...';
            
            // Connect to MQTT broker
            try {
                const clientId = 'smartswitch_' + Math.random().toString(16).substr(2, 8);
                mqttClient = mqtt.connect(MQTT_BROKER_URL, {
                    clientId: clientId,
                    clean: true
                });
                
                mqttClient.on('connect', () => {
                    console.log('Connected to MQTT broker');
                    hideLoading();
                    
                    // Subscribe to device status topic
                    mqttClient.subscribe(`${deviceTopic}/status`);
                    
                    // Update connection status
                    statusIndicator.classList.remove('bg-yellow-500', 'bg-red-500');
                    statusIndicator.classList.add('bg-green-500');
                    statusText.textContent = 'متصل';
                    
                    // Send initial get status request
                    mqttClient.publish(`${deviceTopic}/control`, JSON.stringify({
                        type: 'get_status'
                    }));
                });
                
                mqttClient.on('message', (topic, message) => {
                    if (topic === `${deviceTopic}/status`) {
                        try {
                            const data = JSON.parse(message.toString());
                            
                            if (data.type === 'device_status') {
                                // Update switch states from device
                                if (data.switches) {
                                    data.switches.forEach(sw => {
                                        const existingSwitch = userSwitches.find(s => s.port === sw.port);
                                        if (existingSwitch) {
                                            existingSwitch.state = sw.state === 'on';
                                        }
                                    });
                                    
                                    // Update device storage
                                    if (deviceStorage[currentUser.deviceId]) {
                                        deviceStorage[currentUser.deviceId].switches = userSwitches;
                                    }
                                    
                                    // Re-render switches
                                    renderSwitches();
                                }
                            }
                        } catch (e) {
                            console.error('Error parsing MQTT message:', e);
                        }
                    }
                });
                
                mqttClient.on('error', (err) => {
                    console.error('MQTT connection error:', err);
                    statusIndicator.classList.remove('bg-green-500', 'bg-yellow-500');
                    statusIndicator.classList.add('bg-red-500');
                    statusText.textContent = 'خطأ في الاتصال';
                    hideLoading();
                });
                
                mqttClient.on('offline', () => {
                    statusIndicator.classList.remove('bg-green-500', 'bg-yellow-500');
                    statusIndicator.classList.add('bg-red-500');
                    statusText.textContent = 'غير متصل';
                });
                
                mqttClient.on('reconnect', () => {
                    statusIndicator.classList.remove('bg-green-500', 'bg-red-500');
                    statusIndicator.classList.add('bg-yellow-500');
                    statusText.textContent = 'جاري إعادة الاتصال...';
                });
            } catch (err) {
                console.error('Failed to initialize MQTT:', err);
                statusIndicator.classList.remove('bg-green-500', 'bg-yellow-500');
                statusIndicator.classList.add('bg-red-500');
                statusText.textContent = 'خطأ في الاتصال';
                hideLoading();
            }
        }
        
        // Run on load - show login form
        loginTab.click();
        
        // Handle clicks outside modals
        window.addEventListener('click', (e) => {
            if (e.target === addSwitchModal) {
                addSwitchModal.classList.add('hidden');
            }
            if (e.target === settingsModal) {
                settingsModal.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
